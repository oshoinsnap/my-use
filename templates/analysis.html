<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Data Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#0b4a63;           /* primary */
      --brand-2:#0072ce;         /* accent */
      --ink:#1f2937;             /* body text */
      --muted:#6b7280;           /* secondary text */
      --bg:#f7fafc;              /* page bg */
      --card:#ffffff;            /* cards */
      --line:#e5e7eb;            /* borders */
      --focus:#ffb54b;           /* focus ring */
      --success:#10b981;
    }

    /* Base */
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    img{max-width:100%;height:auto;display:block}
    a{color:var(--brand-2);text-decoration:none}
    a:hover{text-decoration:underline}
    h1,h2,h3{color:#003366;margin:0 0 .5rem}
    p{margin:.5rem 0}

    /* Shared container */
    .container{max-width:1100px;margin:0 auto;padding:0 20px}

    /* Header */
    .site-header{
      background:#fff;
      border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:20;
    }
    .site-header .container{padding-left:20px;padding-right:20px}
    .brand-row{
      display:flex;align-items:center;gap:14px;padding:14px 0;
      position:relative;
      justify-content:flex-start;
    }
    .brand-logo{height:40px;width:auto}
    .brand-name{font-weight:700;font-size:1.1rem;color:#0b2530;letter-spacing:.2px}
    .brand-tag{font-size:.85rem;color:var(--muted)}
    #hamburgerBtn{
      background:none;border:none;cursor:pointer;padding:0;margin-right:16px;
      display:inline-flex;align-items:center;justify-content:center
    }
    #menu{
      display:none; position:absolute; top:56px; left:0;
      background:#fff; border:1px solid var(--line); border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:30; min-width:200px;
    }
    #menu ul{list-style:none;margin:0;padding:8px 0}
    #menu a{display:block;padding:8px 16px;color:var(--brand-2);text-decoration:none}

    /* Stats and cards */
    .stats { display: flex; gap: 20px; margin: 20px 0; }
    .stat-card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; }
    .chart { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; }
    form { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; }
    input[type="file"], textarea, input[type="text"] { margin: 10px 0; width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 4px; }
    input[type="submit"] {
      background-color: var(--brand-2);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
    }
    input[type="submit"]:hover { background-color: #0056b3; }
    input[type="submit"]:focus { outline: 3px solid var(--focus); outline-offset: 2px; }
    .nav { margin-bottom: 20px; }
    .nav a { margin-right: 15px; color: var(--brand-2); text-decoration: none; }
    .nav a:hover { text-decoration: underline; }

    /* Flash messages */
    .flash-message {
      background: #fff3cd;
      border-bottom: 1px solid #ffeaa7;
      padding: 20px 0;
      color: #856404;
      font-weight: 500;
      margin: 20px 0;
    }

    /* ML Section */
    .ml-section {
      margin-top: 40px;
      padding: 20px;
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .ml-section h2 {
      margin-top: 0;
      color: #003366;
    }
    .ml-results {
      white-space: pre-wrap;
      background: #f9fafb;
      border: 1px solid var(--line);
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <div class="brand-row" role="banner" aria-label="List Refiner">
        <button id="hamburgerBtn" aria-label="Open menu" aria-expanded="false" aria-controls="menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--brand-2)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <img src="https://pricing.reachengine.io/images/transaction/n-logo.png" alt="ReachEngine" class="brand-logo">
        <div style="display:flex;flex-direction:column;justify-content:center">
          <div class="brand-name">ListRefiner</div>
          <div class="brand-tag">Clean &amp; combine email lists from Excel in seconds</div>
        </div>
        <nav id="menu" role="navigation" aria-label="Tool navigation">
          <ul>
            <li><a href="combiner.html">Excel Combiner &amp; Deduper</a></li>
            <li><a href="matcher.html">Email Matcher</a></li>
            <li><a href="merger.html">Email Sheet Merger</a></li>
            <li><a href="splitter.html">Industry Splitter</a></li>
            <li><a href="cleaner.html">Email Cleaner</a></li>
            <li><a href="analysis.html">Data Analysis Dashboard</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="nav">
      <a href="/">‚Üê Back to Home</a>
    </div>
    <h1>Email Data Analysis Dashboard</h1>
    <p>Upload your email data file to get insights and visualizations.</p>

    <form action="/analyze_data" method="POST" enctype="multipart/form-data">
      <label for="file">Select CSV or Excel file:</label>
      <input type="file" name="file" accept=".csv,.xlsx" required>
      <br>
      <label for="email_column">Email column name:</label>
      <input type="text" name="email_column" value="email" required>
      <br>
      {% if columns %}
      <label for="selected_column">Select columns to chart (hold Ctrl to select multiple):</label>
      <select name="selected_column" multiple>
        {% for col in columns %}
        <option value="{{ col }}" {% if col == selected_column %}selected{% endif %}>{{ col }}</option>
        {% endfor %}
      </select>
      <br>
      <label for="label_mapping">Label mapping (optional, e.g., yes=opened,no=not opened):</label>
      <input type="text" name="label_mapping" placeholder="yes=opened,no=not opened">
      <br>
      {% endif %}
      <input type="submit" value="Analyze Data">
    </form>

    {% if stats %}
    <div class="stats">
      <div class="stat-card">
        <h3>Total Emails</h3>
        <p>{{ stats.total_emails }}</p>
      </div>
      <div class="stat-card">
        <h3>Unique Emails</h3>
        <p>{{ stats.unique_emails }}</p>
      </div>
      <div class="stat-card">
        <h3>Duplicates</h3>
        <p>{{ stats.duplicates }}</p>
      </div>
    </div>

    {% if domain_plot %}
    <div class="chart">
      <h3>Email Domain Distribution</h3>
      <img src="data:image/png;base64,{{ domain_plot }}" alt="Domain Distribution Chart">
    </div>
    {% endif %}

    {% for col, plot in column_plots %}
    <div class="chart">
      <h3>Chart for {{ col }}</h3>
      <img src="data:image/png;base64,{{ plot }}" alt="Column Chart">
    </div>
    {% endfor %}
    {% endif %}

    {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-message">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
    {% endwith %}

    <!-- ML Model Training Section -->
    <div class="ml-section">
      <h2>ML Model Training</h2>
      <p>Upload labeled email data (with a 'label' column) to train a Random Forest classifier.</p>
      <form action="/train_model" method="POST" enctype="multipart/form-data">
        <label for="train_file">Select training CSV or Excel file:</label>
        <input type="file" name="train_file" accept=".csv,.xlsx" required>
        <br>
        <label for="email_column_train">Email column name:</label>
        <input type="text" name="email_column_train" value="email" required>
        <br>
        <label for="label_column">Label column name:</label>
        <input type="text" name="label_column" value="label" required>
        <br>
        <input type="submit" value="Train Model">
      </form>
      {% if training_report %}
      <div class="ml-results">
        <h3>Training Report</h3>
        <pre>{{ training_report }}</pre>
        <p><strong>Accuracy:</strong> {{ training_accuracy }}</p>
        {% if report_file %}
        <p><a href="{{ url_for('download_file', filename=report_file) }}" download>Download Training Report</a></p>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- ML Prediction Section -->
    <div class="ml-section">
      <h2>ML Email Validity Prediction</h2>
      <p>Enter emails (one per line) to predict their validity using the trained model.</p>
      <form action="/predict_emails" method="POST">
        <label for="emails_input">Emails:</label>
        <textarea name="emails_input" rows="6" placeholder="email1@example.com&#10;email2@example.com" required></textarea>
        <br>
        <input type="submit" value="Predict Validity">
      </form>
      {% if prediction_results %}
      <div class="ml-results">
        <h3>Prediction Results</h3>
        <pre>{{ prediction_results }}</pre>
      </div>
      {% endif %}
    </div>

  </div>

  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Hamburger menu toggle
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const menu = document.getElementById('menu');

    hamburgerBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', String(!expanded));
      menu.style.display = expanded ? 'none' : 'block';
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      if (!menu.contains(event.target) && !hamburgerBtn.contains(event.target)) {
        menu.style.display = 'none';
        hamburgerBtn.setAttribute('aria-expanded', 'false');
      }
    });
  </script>
</body>
</html>
